<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatBI - 产品能力配置</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
}

body {
  min-height: 100vh;
  background-color: #f9f9fc;
  color: #333;
}

.main-content {
  padding: 30px;
  background-color: #fff;
  border-radius: 8px;
  margin: 20px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.03);
  overflow-y: auto;
}

.content-page {
  display: none;
}

.content-page.active {
  display: block;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.page-title {
  font-size: 22px;
  font-weight: 500;
  color: #333;
}

.create-button {
  background-color: #4e7eff;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  font-size: 14px;
  transition: background-color 0.2s;
}

.create-button:hover {
  background-color: #3a6ae6;
}

.create-button i {
  margin-right: 6px;
}

.tabs {
  display: flex;
  border-bottom: 1px solid #eee;
  margin-bottom: 24px;
}

.tab {
  padding: 12px 24px;
  cursor: pointer;
  color: #666;
  font-size: 14px;
  position: relative;
}

.tab.active {
  color: #4e7eff;
}

.tab.active::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 100%;
  height: 2px;
  background-color: #4e7eff;
}

.assistant-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
}

.assistant-card {
  background-color: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  border: 1px solid #eee;
  transition: transform 0.2s, box-shadow 0.2s;
}

.assistant-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.assistant-avatar {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background-color: #f0f5ff;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 12px;
  overflow: hidden;
}

.assistant-avatar svg {
  width: 50px;
  height: 50px;
}

.assistant-name {
  font-size: 16px;
  font-weight: 500;
  color: #333;
  margin-bottom: 16px;
  text-align: center;
}

.assistant-actions {
  display: flex;
  justify-content: center;
  gap: 8px;
  width: 100%;
}

.action-button {
  background: none;
  border: none;
  cursor: pointer;
  padding: 6px;
  border-radius: 4px;
  color: #666;
  transition: background-color 0.2s;
}

.action-button:hover {
  background-color: #f5f6fa;
  color: #4e7eff;
}

.empty-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #999;
  font-size: 16px;
  padding: 100px 0;
}

.empty-placeholder i {
  font-size: 60px;
  margin-bottom: 20px;
  color: #ccc;
}

/* 分析思路页面样式 */
#analysisPathPage .container {
  width: 100%;
  max-width: 1280px;
  margin: 0 auto;
  padding: 20px;
}

#analysisPathPage header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding-bottom: 15px;
  border-bottom: 1px solid #eee;
}

#analysisPathPage h1, #analysisPathPage h2, #analysisPathPage h3 {
  color: #333;
}

#analysisPathPage .button {
  padding: 10px 15px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  transition: background-color 0.3s;
}

#analysisPathPage .button-primary {
  background-color: #3498db;
  color: white;
}

#analysisPathPage .button-primary:hover {
  background-color: #2980b9;
}

#analysisPathPage .button-success {
  background-color: #27ae60;
  color: white;
}

#analysisPathPage .button-success:hover {
  background-color: #219653;
}

#analysisPathPage .button-danger {
  background-color: #e74c3c;
  color: white;
}

#analysisPathPage .button-danger:hover {
  background-color: #c0392b;
}

#analysisPathPage .button-preview {
  background-color: #9b59b6;
  color: white;
}

#analysisPathPage .button-preview:hover {
  background-color: #8e44ad;
  color: white;
}

/* 管理页面样式 */
#analysisPathPage .tab-container {
  margin-bottom: 20px;
}

#analysisPathPage .tabs {
  display: flex;
  border-bottom: 1px solid #eee;
  margin-bottom: 15px;
}

#analysisPathPage .tab {
  padding: 10px 20px;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  white-space: nowrap;
}

#analysisPathPage .tab.active {
  border-bottom: 2px solid #3498db;
  color: #3498db;
  font-weight: bold;
}

#analysisPathPage .tab-content {
  display: none;
}

#analysisPathPage .tab-content.active {
  display: block;
}

#analysisPathPage .search-bar {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  margin-bottom: 15px;
}

#analysisPathPage .analysis-path-list {
  margin-top: 20px;
}

#analysisPathPage .analysis-path-item {
  padding: 15px;
  background-color: white;
  border-radius: 4px;
  margin-bottom: 15px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  transition: transform 0.2s, box-shadow 0.2s;
}

#analysisPathPage .analysis-path-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

#analysisPathPage .analysis-path-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

#analysisPathPage .analysis-path-title {
  font-weight: bold;
  font-size: 18px;
}

#analysisPathPage .analysis-path-actions {
  display: flex;
  gap: 10px;
}

#analysisPathPage .tag {
  display: inline-block;
  padding: 3px 8px;
  background-color: #e1f5fe;
  color: #0288d1;
  border-radius: 3px;
  font-size: 12px;
  margin-right: 5px;
  margin-bottom: 5px;
}

#analysisPathPage .tag-object {
  background-color: #e8f5e9;
  color: #388e3c;
}

#analysisPathPage .tag-module {
  background-color: #e3f2fd;
  color: #1565c0;
}

#analysisPathPage .tag-knowledge {
  background-color: #fff8e1;
  color: #f57f17;
}

#analysisPathPage .tag-strategy {
  background-color: #f1f8e9;
  color: #558b2f;
}

#analysisPathPage .analysis-path-components {
  margin-top: 10px;
  padding: 10px;
  background-color: #f9f9f9;
  border-radius: 4px;
}

#analysisPathPage .component-section {
  margin-bottom: 10px;
}

#analysisPathPage .component-title {
  font-weight: bold;
  color: #95a5a6;
  margin-bottom: 5px;
  font-size: 14px;
}

#analysisPathPage .component-items {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}

#analysisPathPage .component-item {
  background-color: white;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 3px 8px;
  font-size: 13px;
}

/* 创建页面样式 */
#analysisPathPage .page {
  display: none;
}

#analysisPathPage .page.active {
  display: block;
}

#analysisPathPage .breadcrumb {
  display: flex;
  margin-bottom: 20px;
  font-size: 14px;
  color: #95a5a6;
}

#analysisPathPage .breadcrumb a {
  color: #3498db;
  text-decoration: none;
}

#analysisPathPage .breadcrumb a:hover {
  text-decoration: underline;
}

#analysisPathPage .breadcrumb .separator {
  margin: 0 10px;
}

#analysisPathPage .form-group {
  margin-bottom: 20px;
}

#analysisPathPage label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
}

#analysisPathPage input, #analysisPathPage textarea, #analysisPathPage select {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

#analysisPathPage textarea {
  min-height: 80px;
  resize: vertical;
}

#analysisPathPage .card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 15px;
  margin-bottom: 30px;
}

#analysisPathPage .card {
  background-color: white;
  border-radius: 4px;
  padding: 15px;
  border: 1px solid #eee;
  cursor: pointer;
  transition: all 0.3s ease;
}

#analysisPathPage .card:hover {
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

#analysisPathPage .card.selected {
  border-color: #3498db;
  background-color: rgba(52, 152, 219, 0.05);
}

#analysisPathPage .card-title {
  font-weight: bold;
  margin-bottom: 5px;
  color: #333;
}

#analysisPathPage .card-description {
  font-size: 14px;
  color: #95a5a6;
}

#analysisPathPage .section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
  transition: all 0.3s ease;
}

#analysisPathPage .section-header.highlight {
  background-color: rgba(52, 152, 219, 0.1);
  padding: 10px;
  border-radius: 4px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

#analysisPathPage .section-title {
  display: flex;
  align-items: center;
}

#analysisPathPage .section-number {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  background-color: #3498db;
  color: white;
  border-radius: 50%;
  margin-right: 10px;
  font-weight: bold;
}

/* 更新后的选中项目样式，添加编号和箭头 */
#analysisPathPage .selected-items {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
  margin-top: 15px;
}

#analysisPathPage .selected-item {
  background-color: white;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 5px 10px 5px 5px;
  display: flex;
  align-items: center;
  font-size: 14px;
}

#analysisPathPage .selected-item .item-number {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 22px;
  height: 22px;
  background-color: #3498db;
  color: white;
  border-radius: 50%;
  margin-right: 8px;
  font-size: 12px;
  font-weight: bold;
}

#analysisPathPage .selected-item .remove {
  margin-left: 8px;
  color: #e74c3c;
  cursor: pointer;
}

#analysisPathPage .item-arrow {
  color: #95a5a6;
  font-size: 16px;
  display: flex;
  align-items: center;
}

#analysisPathPage .object-chip {
  display: inline-block;
  padding: 5px 10px;
  background-color: #eee;
  border-radius: 20px;
  margin-right: 10px;
  margin-bottom: 10px;
  font-size: 14px;
  cursor: pointer;
  transition: background-color 0.2s;
}

#analysisPathPage .object-chip:hover {
  background-color: #e0e0e0;
}

#analysisPathPage .object-chip.selected {
  background-color: #27ae60;
  color: white;
}

#analysisPathPage .action-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 30px;
  padding-top: 20px;
  border-top: 1px solid #eee;
}

#analysisPathPage .section-container {
  background-color: white;
  border-radius: 4px;
  padding: 20px;
  margin-bottom: 30px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  scroll-margin-top: 100px; /* 滚动到此元素时的偏移量，留出足够的空间给粘性等式 */
}

#analysisPathPage .dataset-strategy-container {
  margin-top: 20px;
  border: 1px solid #eee;
  border-radius: 4px;
  padding: 15px;
  margin-bottom: 20px;
}

#analysisPathPage .dataset-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px dashed #eee;
}

#analysisPathPage .dataset-title {
  font-weight: bold;
  color: #333;
}

#analysisPathPage .strategy-section {
  margin-bottom: 20px;
}

#analysisPathPage .strategy-section h4 {
  margin-bottom: 10px;
  color: #95a5a6;
}

#analysisPathPage .no-datasets-selected {
  padding: 30px;
  text-align: center;
  color: #95a5a6;
  font-style: italic;
  background-color: #f5f5f5;
  border-radius: 4px;
}

#analysisPathPage .two-columns {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

/* 奇妙等式样式 - 改进版 */
#analysisPathPage .equation-container {
  display: flex;
  justify-content: center;
  align-items: center; /* 修改为center使所有元素垂直居中 */
  margin: 30px 0;
  padding: 20px;
  background-color: #f7f9fa;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  min-height: 120px; /* 设置最小高度 */
  flex-wrap: wrap; /* 允许换行 */
  transition: all 0.3s ease;
}

/* 悬浮等式容器样式 */
#analysisPathPage .equation-container.sticky {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  margin: 0;
  padding: 12px 20px;
  border-radius: 0;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  min-height: auto;
  height: auto;
}

/* 添加内容容器，确保内容居中且宽度保持一致 */
#analysisPathPage .equation-content {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  max-width: 1240px; /* 和白色主体内容区域相同的宽度 */
  margin: 0 auto;
  padding: 0 20px;
}

#analysisPathPage .equation-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 15px;
  min-width: 150px; /* 增加最小宽度 */
  border-radius: 4px;
  transition: all 0.3s ease;
  cursor: pointer;
  margin: 0 5px; /* 移除底部margin */
  text-align: center;
  position: relative;
}

/* 吸顶状态下简化的等式样式 */
#analysisPathPage .sticky .equation-item {
  padding: 8px 12px;
  min-width: auto;
  height: auto;
}

#analysisPathPage .equation-item:hover {
  background-color: rgba(52, 152, 219, 0.1);
}

#analysisPathPage .equation-item.active {
  background-color: rgba(52, 152, 219, 0.2);
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

#analysisPathPage .equation-item .icon {
  font-size: 24px;
  margin-bottom: 10px;
  color: #3498db;
}

/* 吸顶状态下隐藏图标 */
#analysisPathPage .sticky .equation-item .icon {
  display: none;
}

#analysisPathPage .equation-item .text {
  font-weight: bold;
  color: #333;
  font-size: 14px;
  margin-bottom: 10px; /* 增加文字与标签的间距 */
}

/* 吸顶状态下调整文字样式 */
#analysisPathPage .sticky .equation-item .text {
  margin-bottom: 5px;
  font-size: 13px;
}

#analysisPathPage .equation-equals, #analysisPathPage .equation-plus {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  font-weight: bold;
  margin: 0 15px;
  color: #95a5a6;
  align-self: center; /* 垂直居中 */
  height: 40px; /* 固定高度 */
}

/* 吸顶状态下调整符号样式 */
#analysisPathPage .sticky .equation-equals, 
#analysisPathPage .sticky .equation-plus {
  font-size: 18px;
  height: auto;
  margin: 0 8px;
}

#analysisPathPage .equation-selected-tags {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  padding: 5px;
  gap: 5px;
  width: 100%; /* 设置宽度为100%以便标签位于下方 */
}

/* 吸顶状态下调整标签容器样式 */
#analysisPathPage .sticky .equation-selected-tags {
  padding: 0;
}

#analysisPathPage .equation-tag {
  display: inline-block;
  padding: 3px 6px;
  border-radius: 3px;
  font-size: 11px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

/* 吸顶状态下调整标签样式 */
#analysisPathPage .sticky .equation-tag {
  font-size: 10px;
  padding: 2px 5px;
}

#analysisPathPage .equation-tag-module {
  background-color: #e3f2fd;
  color: #1565c0;
}

#analysisPathPage .equation-tag-knowledge {
  background-color: #fff8e1;
  color: #f57f17;
}

#analysisPathPage .equation-tag-strategy {
  background-color: #f1f8e9;
  color: #558b2f;
}

/* 列表页的思维导图样式 - 修改后只显示右侧三个模块 */
#analysisPathPage .mindmap-container {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 15px 0;
  padding: 15px;
  background-color: #f7f9fa;
  border-radius: 4px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

#analysisPathPage .mindmap-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 10px;
  min-width: 100px;
  border-radius: 4px;
  margin: 0 3px;
  text-align: center;
  position: relative;
  align-self: center;
}

#analysisPathPage .mindmap-item .icon {
  font-size: 18px;
  margin-bottom: 5px;
  color: #3498db;
}

#analysisPathPage .mindmap-item .text {
  font-weight: bold;
  color: #333;
  font-size: 12px;
  margin-bottom: 8px;
}

#analysisPathPage .mindmap-equals, #analysisPathPage .mindmap-plus {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: bold;
  margin: 0 10px;
  color: #95a5a6;
  align-self: center;
  height: 30px;
}

#analysisPathPage .mindmap-selected-tags {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 3px;
  max-width: 150px;
  overflow-y: auto;
  max-height: 60px;
}

#analysisPathPage .mindmap-tag {
  display: inline-block;
  padding: 2px 4px;
  border-radius: 2px;
  font-size: 10px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

/* 添加标签上的编号样式 */
#analysisPathPage .mindmap-tag .tag-number {
  background-color: #1565c0;
  color: white;
  border-radius: 50%;
  width: 14px;
  height: 14px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 8px;
  margin-right: 2px;
}

#analysisPathPage .mindmap-tag-module {
  background-color: #e3f2fd;
  color: #1565c0;
}

#analysisPathPage .mindmap-tag-knowledge {
  background-color: #fff8e1;
  color: #f57f17;
}

#analysisPathPage .mindmap-tag-strategy {
  background-color: #f1f8e9;
  color: #558b2f;
}

#analysisPathPage .object-tags {
  margin-top: 10px;
}

/* 为粘性等式预留占位符 */
#equation-placeholder {
  display: none;
  margin: 0;
  padding: 0;
}

#equation-placeholder.active {
  display: block;
}

/* 知识和策略筛选器样式 */
.filter-container {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-bottom: 20px;
}

.filter-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
}

.filter-label {
  font-weight: bold;
  color: #666;
  min-width: 80px;
}

.filter-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.filter-chip {
  padding: 5px 10px;
  background-color: #f1f1f1;
  border-radius: 20px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
}

.filter-chip:hover {
  background-color: #e0e0e0;
}

.filter-chip.selected {
  background-color: #3498db;
  color: white;
}

.search-filter {
  position: relative;
  margin-bottom: 15px;
}

.search-filter input {
  padding-left: 35px;
  padding-right: 10px;
  width: 100%;
}

.search-filter i {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #aaa;
  font-size: 14px;
  z-index: 1;
}

.top-recommendations {
  margin-bottom: 20px;
}

.top-recommendations h4 {
  font-size: 15px;
  margin-bottom: 10px;
  color: #666;
}

.see-more-btn {
  color: #3498db;
  background: none;
  border: none;
  font-size: 13px;
  cursor: pointer;
  text-decoration: underline;
  margin-top: 10px;
  display: block;
}

/* 整体要求步骤样式 */
#requirementSection textarea {
  min-height: 100px;
  margin-bottom: 15px;
}

.knowledge-pill {
  display: inline-block;
  background-color: #fff8e1;
  color: #f57f17;
  padding: 5px 10px;
  border-radius: 20px;
  margin-right: 8px;
  margin-bottom: 8px;
  font-size: 13px;
  cursor: pointer;
}

.knowledge-pill:hover {
  background-color: #ffecb3;
}

.pills-container {
  margin-top: 15px;
}

/* 搜索建议框样式 */
.search-suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background-color: white;
  border: 1px solid #ddd;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  z-index: 100;
  max-height: 250px;
  overflow-y: auto;
  display: none;
}

.search-suggestions.active {
  display: block;
}

.suggestion-item {
  padding: 10px 15px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
  transition: background-color 0.2s;
}

.suggestion-item:hover {
  background-color: #f5f5f5;
}

.suggestion-item:last-child {
  border-bottom: none;
}

.suggestion-id {
  color: #999;
  font-size: 12px;
  margin-right: 8px;
}

.suggestion-name {
  font-weight: bold;
}

.suggestion-owner {
  color: #666;
  font-size: 12px;
  margin-left: 8px;
}

/* 弹出层样式改进 */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0,0,0,0.5);
  z-index: 1000;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
  display: none;
  backdrop-filter: blur(3px);
}

.modal-overlay.active {
  display: flex;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-container {
  background-color: white;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  max-width: 900px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  position: relative;
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: #f9f9fc;
  border-radius: 12px 12px 0 0;
}

.modal-title {
  font-size: 20px;
  font-weight: bold;
  color: #333;
}

.modal-close {
  background: none;
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: #666;
  transition: all 0.2s;
  font-size: 22px;
}

.modal-close:hover {
  background-color: rgba(0,0,0,0.05);
  color: #333;
}

.modal-body {
  padding: 24px;
  flex: 1;
  overflow-y: auto;
}

.modal-footer {
  padding: 16px 24px;
  border-top: 1px solid #eee;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  background-color: #f9f9fc;
  border-radius: 0 0 12px 12px;
}

.modal-footer .button {
  padding: 10px 18px;
  font-size: 14px;
  border-radius: 6px;
  transition: all 0.2s;
}

.modal-footer .button-danger {
  background-color: #fff;
  color: #e74c3c;
  border: 1px solid #e74c3c;
}

.modal-footer .button-danger:hover {
  background-color: #fdeeec;
}

/* 层级筛选器样式改进 */
.hierarchy-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 24px;
  background-color: #f9f9fc;
  padding: 16px;
  border-radius: 8px;
}

.hierarchy-filter {
  flex: 1;
  min-width: 200px;
}

.hierarchy-filter-title {
  font-weight: bold;
  margin-bottom: 8px;
  color: #555;
  font-size: 13px;
}

.hierarchy-filter select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  background-color: white;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23555' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  cursor: pointer;
  transition: border-color 0.2s;
}

.hierarchy-filter select:hover {
  border-color: #aaa;
}

.hierarchy-filter select:focus {
  border-color: #3498db;
  outline: none;
  box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

/* 单级筛选器样式改进 */
.single-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-bottom: 24px;
  background-color: #f0f6fa;
  padding: 16px;
  border-radius: 8px;
}

.single-filter {
  flex: 1;
  min-width: 180px;
}

.single-filter-title {
  font-weight: bold;
  margin-bottom: 8px;
  color: #555;
  font-size: 13px;
}

.single-filter select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  background-color: white;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23555' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  cursor: pointer;
  transition: border-color 0.2s;
}

.single-filter select:hover {
  border-color: #aaa;
}

.single-filter select:focus {
  border-color: #3498db;
  outline: none;
  box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

/* 知识列表样式改进 */
.knowledge-list {
  border: 1px solid #eee;
  border-radius: 8px;
  margin-top: 20px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.knowledge-item {
  padding: 15px 18px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
  transition: background-color 0.2s;
  display: flex;
  align-items: center;
  background-color: white;
}

.knowledge-item:hover {
  background-color: #f5f9fc;
}

.knowledge-item:last-child {
  border-bottom: none;
}

.knowledge-checkbox {
  margin-right: 15px;
  width: 18px;
  height: 18px;
  accent-color: #3498db;
}

.knowledge-info {
  flex: 1;
}

.knowledge-title {
  font-weight: bold;
  margin-bottom: 5px;
  color: #333;
}

.knowledge-meta {
  display: flex;
  color: #666;
  font-size: 12px;
  gap: 15px;
  flex-wrap: wrap;
}

.knowledge-id, .knowledge-owner, .knowledge-type {
  display: flex;
  align-items: center;
}

.knowledge-id i, .knowledge-owner i, .knowledge-type i {
  margin-right: 5px;
  font-size: 14px;
  color: #999;
}

/* 组织架构选择器样式 */
.org-structure-selector {
  margin-bottom: 20px;
}

.org-tabs {
  display: flex;
  border-bottom: 1px solid #eee;
  margin-bottom: 15px;
}

.org-tab {
  padding: 8px 16px;
  cursor: pointer;
  color: #666;
  font-size: 14px;
  position: relative;
  transition: all 0.2s;
}

.org-tab.active {
  color: #3498db;
  font-weight: bold;
}

.org-tab.active::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 100%;
  height: 2px;
  background-color: #3498db;
}

.org-content {
  display: none;
  margin-top: 15px;
}

.org-content.active {
  display: block;
  animation: fadeIn 0.3s ease;
}

.org-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

@media (max-width: 1200px) {
  .assistant-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 900px) {
  .assistant-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 767px) {
  #analysisPathPage .tabs {
    flex-wrap: wrap;
  }

  #analysisPathPage .tab {
    flex: 1 0 auto;
    text-align: center;
    padding: 10px 12px;
    font-size: 14px;
  }

  #analysisPathPage .card-grid {
    grid-template-columns: 1fr;
  }

  #analysisPathPage .analysis-path-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }

  #analysisPathPage .analysis-path-actions {
    width: 100%;
    justify-content: flex-end;
  }

  #analysisPathPage .two-columns {
    grid-template-columns: 1fr;
  }

  #analysisPathPage .equation-container {
    flex-direction: column;
    padding: 10px;
    align-items: center;
  }

  #analysisPathPage .equation-equals, #analysisPathPage .equation-plus {
    margin: 10px 0;
  }

  #analysisPathPage .equation-item {
    margin-bottom: 10px;
    min-width: 200px;
  }

  #analysisPathPage .mindmap-container {
    flex-direction: column;
    align-items: center;
  }

  #analysisPathPage .mindmap-equals, #analysisPathPage .mindmap-plus {
    margin: 5px 0;
  }

  #analysisPathPage .mindmap-item {
    margin-bottom: 10px;
    min-width: 150px;
  }
  
  .hierarchy-filters, .single-filters {
    flex-direction: column;
    gap: 15px;
  }
  
  .hierarchy-filter, .single-filter {
    min-width: 100%;
  }
  
  .modal-container {
    max-height: 95vh;
    width: 95%;
  }
}

@media (max-width: 768px) {
  .main-content {
    margin: 10px;
    padding: 15px;
  }

  .assistant-grid {
    grid-template-columns: repeat(1, 1fr);
  }
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

<div class="main-content">
<!-- 空白页面（该功能页面正在建设中） -->
<div class="content-page" id="page-empty">
<div class="empty-placeholder">
<i class="fas fa-tools"></i>
<p>该功能页面正在建设中...</p>
</div>
</div>

<!-- 分析思路页面 -->
<div class="content-page active" id="page-analysisPath">
<div id="analysisPathPage">
<div class="container">
<!-- 管理页面 -->
<div class="page active" id="managePage">
<header>
<h1>分析思路配置与管理</h1>
<button class="button button-primary" id="newAnalysisPath">+ 新建分析思路</button>
</header>

<div class="tab-container">
<div class="tabs">
<div class="tab active" data-tab="allPaths">全部分析思路</div>
<div class="tab" data-tab="byObjects">按分析对象查看</div>
</div>

<div class="tab-content active" id="allPaths">
<input type="text" class="search-bar" placeholder="搜索分析思路...">

<div class="analysis-path-list">
<div class="analysis-path-item">
<div class="analysis-path-header">
<div class="analysis-path-title">季度业绩分析思路</div>
<div class="analysis-path-actions">
<button class="button button-primary edit-path">编辑</button>
<button class="button button-danger">删除</button>
<button class="button button-preview">预览</button>
</div>
</div>

<!-- 修改后的思维导图，移除了左侧部分和等号 -->
<div class="mindmap-container">
<div class="mindmap-item">
<div class="icon">📊</div>
<div class="text">分析模块</div>
<div class="mindmap-selected-tags">
<div class="mindmap-tag mindmap-tag-module"><span class="tag-number">1</span>业绩</div>
<div class="mindmap-tag mindmap-tag-module"><span class="tag-number">2</span>房源</div>
</div>
</div>
<div class="mindmap-plus">+</div>
<div class="mindmap-item">
<div class="icon">🧠</div>
<div class="text">业务知识</div>
<div class="mindmap-selected-tags">
<div class="mindmap-tag mindmap-tag-knowledge">业务知识1</div>
<div class="mindmap-tag mindmap-tag-knowledge">业务知识2</div>
<div class="mindmap-tag mindmap-tag-knowledge">业务知识3</div>
</div>
</div>
<div class="mindmap-plus">+</div>
<div class="mindmap-item">
<div class="icon">📝</div>
<div class="text">管理策略</div>
<div class="mindmap-selected-tags">
<div class="mindmap-tag mindmap-tag-strategy">策略1</div>
<div class="mindmap-tag mindmap-tag-strategy">策略3</div>
</div>
</div>
</div>

<div class="object-tags">
<span class="tag tag-object">分析对象: 门店</span>
<span class="tag tag-object">分析对象: 大区</span>
</div>
</div>

<div class="analysis-path-item">
<div class="analysis-path-header">
<div class="analysis-path-title">客源分析思路</div>
<div class="analysis-path-actions">
<button class="button button-primary edit-path">编辑</button>
<button class="button button-danger">删除</button>
<button class="button button-preview">预览</button>
</div>
</div>

<!-- 修改后的思维导图 -->
<div class="mindmap-container">
<div class="mindmap-item">
<div class="icon">📊</div>
<div class="text">分析模块</div>
<div class="mindmap-selected-tags">
<div class="mindmap-tag mindmap-tag-module"><span class="tag-number">1</span>客源</div>
<div class="mindmap-tag mindmap-tag-module"><span class="tag-number">2</span>带看</div>
</div>
</div>
<div class="mindmap-plus">+</div>
<div class="mindmap-item">
<div class="icon">🧠</div>
<div class="text">业务知识</div>
<div class="mindmap-selected-tags">
<div class="mindmap-tag mindmap-tag-knowledge">业务知识4</div>
<div class="mindmap-tag mindmap-tag-knowledge">业务知识5</div>
</div>
</div>
<div class="mindmap-plus">+</div>
<div class="mindmap-item">
<div class="icon">📝</div>
<div class="text">管理策略</div>
<div class="mindmap-selected-tags">
<div class="mindmap-tag mindmap-tag-strategy">策略2</div>
<div class="mindmap-tag mindmap-tag-strategy">策略4</div>
</div>
</div>
</div>

<div class="object-tags">
<span class="tag tag-object">分析对象: CA</span>
<span class="tag tag-object">分析对象: 城市</span>
</div>
</div>

<div class="analysis-path-item">
<div class="analysis-path-header">
<div class="analysis-path-title">商机分析思路</div>
<div class="analysis-path-actions">
<button class="button button-primary edit-path">编辑</button>
<button class="button button-danger">删除</button>
<button class="button button-preview">预览</button>
</div>
</div>

<!-- 修改后的思维导图 -->
<div class="mindmap-container">
<div class="mindmap-item">
<div class="icon">📊</div>
<div class="text">分析模块</div>
<div class="mindmap-selected-tags">
<div class="mindmap-tag mindmap-tag-module"><span class="tag-number">1</span>商机</div>
</div>
</div>
<div class="mindmap-plus">+</div>
<div class="mindmap-item">
<div class="icon">🧠</div>
<div class="text">业务知识</div>
<div class="mindmap-selected-tags">
<div class="mindmap-tag mindmap-tag-knowledge">业务知识6</div>
<div class="mindmap-tag mindmap-tag-knowledge">业务知识5</div>
</div>
</div>
<div class="mindmap-plus">+</div>
<div class="mindmap-item">
<div class="icon">📝</div>
<div class="text">管理策略</div>
<div class="mindmap-selected-tags">
<div class="mindmap-tag mindmap-tag-strategy">策略1</div>
<div class="mindmap-tag mindmap-tag-strategy">策略2</div>
</div>
</div>
</div>

<div class="object-tags">
<span class="tag tag-object">分析对象: 大部</span>
<span class="tag tag-object">分析对象: 区域</span>
</div>
</div>
</div>
</div>

<div class="tab-content" id="byObjects">
<div class="tab-container">
<div class="tabs">
<div class="tab active" data-tab="object1">门店</div>
<div class="tab" data-tab="object2">CA</div>
<div class="tab" data-tab="object3">大区</div>
<div class="tab" data-tab="object4">大部</div>
<div class="tab" data-tab="object5">城市</div>
<div class="tab" data-tab="object6">区域</div>
<div class="tab" data-tab="object7">全国</div>
</div>

<div class="tab-content active" id="object1">
<div class="analysis-path-item">
<div class="analysis-path-header">
<div class="analysis-path-title">季度业绩分析思路</div>
<div class="analysis-path-actions">
<button class="button button-primary edit-path">编辑</button>
</div>
</div>

<!-- 修改后的思维导图 -->
<div class="mindmap-container">
<div class="mindmap-item">
<div class="icon">📊</div>
<div class="text">分析模块</div>
<div class="mindmap-selected-tags">
<div class="mindmap-tag mindmap-tag-module"><span class="tag-number">1</span>业绩</div>
<div class="mindmap-tag mindmap-tag-module"><span class="tag-number">2</span>房源</div>
</div>
</div>
<div class="mindmap-plus">+</div>
<div class="mindmap-item">
<div class="icon">🧠</div>
<div class="text">业务知识</div>
<div class="mindmap-selected-tags">
<div class="mindmap-tag mindmap-tag-knowledge">业务知识1</div>
<div class="mindmap-tag mindmap-tag-knowledge">业务知识2</div>
<div class="mindmap-tag mindmap-tag-knowledge">业务知识3</div>
</div>
</div>
<div class="mindmap-plus">+</div>
<div class="mindmap-item">
<div class="icon">📝</div>
<div class="text">管理策略</div>
<div class="mindmap-selected-tags">
<div class="mindmap-tag mindmap-tag-strategy">策略1</div>
<div class="mindmap-tag mindmap-tag-strategy">策略3</div>
</div>
</div>
</div>
</div>
</div>

<div class="tab-content" id="object2">
<!-- CA相关分析思路 -->
</div>

<div class="tab-content" id="object3">
<!-- 大区相关分析思路 -->
</div>

<div class="tab-content" id="object4">
<!-- 大部相关分析思路 -->
</div>

<div class="tab-content" id="object5">
<!-- 城市相关分析思路 -->
</div>

<div class="tab-content" id="object6">
<!-- 区域相关分析思路 -->
</div>

<div class="tab-content" id="object7">
<!-- 全国相关分析思路 -->
</div>
</div>
</div>
</div>
</div>

<!-- 创建页面 -->
<div class="page" id="createPage">
<header>
<div class="breadcrumb">
<a href="#" id="backToManage">分析思路管理</a>
<span class="separator">&gt;</span>
<span id="pageTitle">创建新分析思路</span>
</div>
<h1 id="formTitle">创建新分析思路</h1>
</header>

<div class="section-container">
<div class="form-group">
<label for="pathName">分析思路名称</label>
<input type="text" id="pathName" placeholder="例如：季度业绩分析思路">
</div>

<div class="form-group">
<label for="pathDescription">简短描述</label>
<textarea id="pathDescription" rows="3" placeholder="简要描述此分析思路的用途和价值"></textarea>
</div>

<!-- 奇妙等式流程图 -->
<div class="equation-container" id="equation-container">
<div class="equation-content">
<div class="equation-item" id="equationPath">
<div class="icon">🧩</div>
<div class="text">分析思路</div>
</div>
<div class="equation-equals">=</div>
<div class="equation-item" id="equationModule" onclick="scrollToSection('moduleSection')">
<div class="icon">📊</div>
<div class="text">分析模块</div>
<div class="equation-selected-tags" id="selectedModuleTags"></div>
</div>
<div class="equation-plus">+</div>
<div class="equation-item" id="equationKnowledge" onclick="scrollToSection('knowledgeSection')">
<div class="icon">🧠</div>
<div class="text">业务知识</div>
<div class="equation-selected-tags" id="selectedKnowledgeTags"></div>
</div>
<div class="equation-plus">+</div>
<div class="equation-item" id="equationStrategy" onclick="scrollToSection('strategySection')">
<div class="icon">📝</div>
<div class="text">管理策略</div>
<div class="equation-selected-tags" id="selectedStrategyTags"></div>
</div>
</div>
</div>

<!-- 为粘性等式预留的占位符 -->
<div id="equation-placeholder"></div>
</div>

<div class="section-container" id="moduleSection">
<div class="section-header" id="moduleHeader">
<div class="section-title">
<span class="section-number">1</span>
<h2>选择分析模块</h2>
</div>
</div>

<input type="text" class="search-bar" placeholder="搜索分析模块...">
<div class="card-grid">
<div class="card" onclick="toggleSelection(this, 'metricSet')">
<div class="card-title">业绩</div>
<div class="card-description">包含签约金额、成交套数等业绩相关指标</div>
</div>
<div class="card" onclick="toggleSelection(this, 'metricSet')">
<div class="card-title">房源</div>
<div class="card-description">包含房源数量、房源质量等相关指标</div>
</div>
<div class="card" onclick="toggleSelection(this, 'metricSet')">
<div class="card-title">客源</div>
<div class="card-description">包含客源数量、客源质量等相关指标</div>
</div>
<div class="card" onclick="toggleSelection(this, 'metricSet')">
<div class="card-title">带看</div>
<div class="card-description">包含带看量、带看转化率等相关指标</div>
</div>
<div class="card" onclick="toggleSelection(this, 'metricSet')">
<div class="card-title">商机</div>
<div class="card-description">包含商机数、商机转化率等相关指标</div>
</div>
</div>

<div class="selected-items" id="selectedMetrics">
<!-- 选中的指标和指标集将显示在这里 -->
</div>
</div>

<div class="section-container" id="knowledgeSection">
<div class="section-header" id="knowledgeHeader">
<div class="section-title">
<span class="section-number">2</span>
<h2>选择业务知识</h2>
</div>
</div>

<div id="diagnosisContainer">
<div class="no-datasets-selected" id="noDatasetsMessage1">
请先在第一步中选择分析模块
</div>

<!-- 动态生成的业务知识选择区域将显示在这里 -->
</div>
</div>

<div class="section-container" id="strategySection">
<div class="section-header" id="strategyHeader">
<div class="section-title">
<span class="section-number">3</span>
<h2>选择管理策略</h2>
</div>
</div>

<div id="managementContainer">
<div class="no-datasets-selected" id="noDatasetsMessage2">
请先在第一步中选择分析模块
</div>

<!-- 动态生成的管理策略选择区域将显示在这里 -->
</div>
</div>

<div class="section-container" id="requirementSection">
<div class="section-header" id="requirementHeader">
<div class="section-title">
<span class="section-number">4</span>
<h2>填写整体要求</h2>
</div>
</div>

<div class="form-group">
<label for="overallRequirement">整体要求描述</label>
<textarea id="overallRequirement" placeholder="请在这里输入分析思路的整体要求，例如：每月需要重点关注的指标和关键问题..."></textarea>
</div>

<div class="search-filter">
<i class="fas fa-search"></i>
<input type="text" placeholder="搜索相关知识..." id="requirementSearch">
<div class="search-suggestions" id="requirementSuggestions"></div>
</div>

<div class="top-recommendations">
<h4>推荐知识:</h4>
<div class="card-grid">
<div class="card" onclick="addKnowledgeToRequirement(this)">
<div class="card-title">季度业绩分析框架</div>
<div class="card-description">框架型，适用于季度业绩分析场景</div>
</div>
<div class="card" onclick="addKnowledgeToRequirement(this)">
<div class="card-title">租赁市场周期波动</div>
<div class="card-description">知识型，房地产租赁市场周期分析</div>
</div>
<div class="card" onclick="addKnowledgeToRequirement(this)">
<div class="card-title">区域差异化分析</div>
<div class="card-description">方法型，不同区域的业绩差异分析</div>
</div>
</div>
<button class="see-more-btn" onclick="openKnowledgeModal('requirement')">查看更多...</button>
</div>

<div class="selected-items" id="selectedRequirements">
<!-- 选中的整体要求知识会显示在这里 -->
</div>
</div>

<div class="section-container" id="objectSection">
<div class="section-header" id="objectHeader">
<div class="section-title">
<span class="section-number">5</span>
<h2>选择分析对象</h2>
</div>
</div>

<div class="org-structure-selector">
<div class="org-tabs">
<div class="org-tab active" data-org="beike">贝壳城市运营</div>
<div class="org-tab" data-org="decor">整装</div>
</div>

<div class="org-content active" id="beikeOrgContent">
<div class="org-chips">
<div class="object-chip" onclick="toggleObject(this, 'beike')">门店</div>
<div class="object-chip" onclick="toggleObject(this, 'beike')">CA</div>
<div class="object-chip" onclick="toggleObject(this, 'beike')">大区</div>
<div class="object-chip" onclick="toggleObject(this, 'beike')">大部</div>
<div class="object-chip" onclick="toggleObject(this, 'beike')">城市</div>
<div class="object-chip" onclick="toggleObject(this, 'beike')">区域</div>
<div class="object-chip" onclick="toggleObject(this, 'beike')">全国</div>
</div>
</div>

<div class="org-content" id="decorOrgContent">
<div class="org-chips">
<div class="object-chip" onclick="toggleObject(this, 'decor')">城市店</div>
<div class="object-chip" onclick="toggleObject(this, 'decor')">经营部</div>
<div class="object-chip" onclick="toggleObject(this, 'decor')">大区</div>
<div class="object-chip" onclick="toggleObject(this, 'decor')">区域</div>
<div class="object-chip" onclick="toggleObject(this, 'decor')">全国</div>
</div>
</div>
</div>

</div>

<div class="action-buttons">
<button class="button button-danger" id="cancelButton">取消</button>
<button class="button button-success" id="saveButton">保存分析思路</button>
<button class="button button-preview" id="previewButton">预览</button>
</div>
</div>
</div>
</div>
</div>

<!-- 弹出层：知识选择 -->
<div class="modal-overlay" id="knowledgeModal">
<div class="modal-container">
<div class="modal-header">
<div class="modal-title">选择业务知识</div>
<button class="modal-close" onclick="closeModal('knowledgeModal')">&times;</button>
</div>
<div class="modal-body">
<div class="search-filter">
<i class="fas fa-search"></i>
<input type="text" placeholder="搜索知识..." id="modalSearchInput">
</div>

<div class="hierarchy-filters">
<div class="hierarchy-filter">
<div class="hierarchy-filter-title">一级标签</div>
<select id="level1Filter" onchange="updateLevel2Options()">
<option value="">全部</option>
<option value="业务分析">业务分析</option>
<option value="市场研究">市场研究</option>
<option value="管理方法">管理方法</option>
</select>
</div>
<div class="hierarchy-filter">
<div class="hierarchy-filter-title">二级标签</div>
<select id="level2Filter" onchange="updateLevel3Options()">
<option value="">全部</option>
</select>
</div>
<div class="hierarchy-filter">
<div class="hierarchy-filter-title">三级标签</div>
<select id="level3Filter" onchange="filterKnowledgeList()">
<option value="">全部</option>
</select>
</div>
</div>

<div class="single-filters">
<div class="single-filter">
<div class="single-filter-title">业务线</div>
<select id="businessLineFilter" onchange="filterKnowledgeList()">
<option value="">全部</option>
<option value="租赁">租赁</option>
<option value="二手房">二手房</option>
<option value="新房">新房</option>
<option value="全业务线">全业务线</option>
</select>
</div>
<div class="single-filter">
<div class="single-filter-title">负责人</div>
<select id="ownerFilter" onchange="filterKnowledgeList()">
<option value="">全部</option>
<option value="张三">张三</option>
<option value="李四">李四</option>
<option value="王五">王五</option>
</select>
</div>
</div>

<div class="knowledge-list" id="knowledgeList">
<!-- 知识列表项将在这里动态生成 -->
</div>
</div>
<div class="modal-footer">
<button class="button button-danger" onclick="closeModal('knowledgeModal')">取消</button>
<button class="button button-success" onclick="confirmKnowledgeSelection()">确认选择</button>
</div>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
// 分析思路页面的内部事件处理
if (document.getElementById('analysisPathPage')) {
// 新建分析思路按钮
document.getElementById('newAnalysisPath')?.addEventListener('click', function() {
document.getElementById('formTitle').textContent = '创建新分析思路';
document.getElementById('pageTitle').textContent = '创建新分析思路';
clearForm();
showPage('createPage', 'managePage');

// 当页面切换到创建页面时，初始化粘性等式
setTimeout(() => {
setupStickyEquation();
}, 100);
});

// 返回管理页面按钮
document.getElementById('backToManage')?.addEventListener('click', function(e) {
e.preventDefault();
showPage('managePage', 'createPage');
});

// 取消按钮
document.getElementById('cancelButton')?.addEventListener('click', function() {
showPage('managePage', 'createPage');
});

// 编辑按钮点击事件
document.querySelectorAll('.edit-path').forEach(button => {
button.addEventListener('click', function() {
const item = this.closest('.analysis-path-item');
const title = item.querySelector('.analysis-path-title').textContent;

document.getElementById('formTitle').textContent = '编辑分析思路';
document.getElementById('pageTitle').textContent = '编辑分析思路';
document.getElementById('pathName').value = title;

// 在实际应用中，这里应该加载对应分析思路的完整数据
// 为演示，我们模拟加载一些数据
simulateLoadPathData(item);

showPage('createPage', 'managePage');

// 当页面切换到编辑页面时，初始化粘性等式
setTimeout(() => {
setupStickyEquation();
}, 100);
});
});

// 保存按钮功能
document.getElementById('saveButton')?.addEventListener('click', function() {
// 校验必填项
const pathName = document.getElementById('pathName').value.trim();
if (!pathName) {
alert('请输入分析思路名称');
return;
}

// 校验是否选择了分析对象
if (selectedObjects.length === 0) {
alert('请至少选择一个分析对象');
return;
}

// 校验是否选择了分析模块
if (selectedDatasets.length === 0) {
alert('请至少选择一个分析模块');
return;
}

// 在实际应用中，这里应该保存表单数据

// 显示成功消息
alert('分析思路已成功保存！');

// 返回管理页面
showPage('managePage', 'createPage');
});

// 标签切换事件
document.querySelectorAll('#analysisPathPage .tabs .tab').forEach(tab => {
tab.addEventListener('click', function() {
const tabId = this.getAttribute('data-tab');
const tabContainer = this.closest('.tab-container');

tabContainer.querySelectorAll('.tab').forEach(t => {
t.classList.remove('active');
});

tabContainer.querySelectorAll('.tab-content').forEach(content => {
content.classList.remove('active');
});

this.classList.add('active');
const contentElement = document.getElementById(tabId);
if (contentElement) {
contentElement.classList.add('active');
}
});
});

// 组织架构切换事件
document.querySelectorAll('.org-tab').forEach(tab => {
tab.addEventListener('click', function() {
// 移除所有标签的活动状态
document.querySelectorAll('.org-tab').forEach(t => {
t.classList.remove('active');
});

// 添加当前标签的活动状态
this.classList.add('active');

// 隐藏所有内容
document.querySelectorAll('.org-content').forEach(content => {
content.classList.remove('active');
});

// 显示对应的内容
const orgType = this.getAttribute('data-org');
const contentId = orgType + 'OrgContent';
document.getElementById(contentId).classList.add('active');
});
});

// 为奇妙等式的各项添加点击事件
document.getElementById('equationModule')?.addEventListener('click', function() {
scrollToSection('moduleSection');
});

document.getElementById('equationKnowledge')?.addEventListener('click', function() {
scrollToSection('knowledgeSection');
});

document.getElementById('equationStrategy')?.addEventListener('click', function() {
scrollToSection('strategySection');
});

// 初始化
resetDiagnosisAndManagement();

// 初始化搜索框的事件监听
initializeSearchEvents();

// 初始化知识模态框
initializeKnowledgeModal();
}

// 默认显示分析思路页面
showPage('page-analysisPath');

// 显示指定页面
function showPage(showPageId, hidePageId = null) {
if (showPageId === 'createPage' || hidePageId === 'createPage') {
// 在分析思路内部页面切换
if (document.getElementById('analysisPathPage')) {
document.querySelectorAll('#analysisPathPage .page').forEach(page => {
page.classList.remove('active');
});
document.getElementById(showPageId).classList.add('active');
}
} else {
// 在主页面间切换
document.querySelectorAll('.content-page').forEach(page => {
page.classList.remove('active');
});
document.getElementById(showPageId).classList.add('active');
}
}
});

// 初始化搜索相关事件
function initializeSearchEvents() {
// 设置搜索框焦点和失焦事件
const searchInputs = document.querySelectorAll('.search-filter input');
searchInputs.forEach(input => {
// 焦点事件
input.addEventListener('focus', function() {
// 如果有值，才显示建议
if (this.value.trim().length > 0) {
showSuggestions(this, this.id.replace('Search', '').toLowerCase());
}
});

// 失焦事件
input.addEventListener('blur', function() {
// 延迟隐藏建议框，以便可以点击建议
setTimeout(() => {
const suggestionsId = this.id.replace('Search', 'Suggestions');
const suggestionsBox = document.getElementById(suggestionsId);
if (suggestionsBox) {
suggestionsBox.classList.remove('active');
}
}, 200);
});

// 键盘输入事件
input.addEventListener('keyup', function() {
const query = this.value.trim();
const type = this.id.replace('Search', '').toLowerCase();
// 只有当输入值大于0时才显示建议
if (query.length > 0) {
showSuggestions(this, type);
} else {
const suggestionsId = this.id.replace('Search', 'Suggestions');
const suggestionsBox = document.getElementById(suggestionsId);
if (suggestionsBox) {
suggestionsBox.classList.remove('active');
}
}
});
});
}

// 初始化知识模态框
function initializeKnowledgeModal() {
// 设置模态框搜索框的事件
const modalSearchInput = document.getElementById('modalSearchInput');
if (modalSearchInput) {
modalSearchInput.addEventListener('keyup', function() {
filterKnowledgeList();
});
}
}

// 添加滚动效果，使等式在页面滚动时悬浮在顶部并居中对齐
function setupStickyEquation() {
const equationContainer = document.getElementById('equation-container');
const placeholder = document.getElementById('equation-placeholder');
const mainContent = document.querySelector('.main-content');
const sectionContainer = document.querySelector('.section-container');

if (!equationContainer || !mainContent || !sectionContainer) return;

// 获取主内容白色背景区域的宽度
const mainContentWidth = mainContent.offsetWidth;
const sectionContainerWidth = sectionContainer.offsetWidth;
const sectionContainerPadding = parseInt(window.getComputedStyle(sectionContainer).padding);

// 获取等式容器的原始尺寸和位置
const originalRect = equationContainer.getBoundingClientRect();
const originalTop = originalRect.top + window.pageYOffset;
const originalHeight = originalRect.height;
let isSticky = false;

// 移除旧的滚动事件监听器以避免重复监听
window.removeEventListener('scroll', handleScroll);
window.removeEventListener('resize', handleResize);

// 处理滚动事件的函数
function handleScroll() {
const scrollY = window.pageYOffset;
const createPage = document.getElementById('createPage');

// 仅当创建页面处于活动状态时应用悬浮效果
if (!createPage || !createPage.classList.contains('active')) return;

if (scrollY > originalTop && !isSticky) {
// 设置占位符以防止页面跳动
placeholder.style.height = originalHeight + 'px';
placeholder.classList.add('active');

// 固定等式容器并保持内容居中
equationContainer.classList.add('sticky');
equationContainer.style.backgroundColor = '#f7f9fa';

// 确保内容部分居中且宽度与主内容一致
const equationContent = equationContainer.querySelector('.equation-content');
if (equationContent) {
  // 使用节点容器的宽度，这是白色背景部分的宽度
  equationContent.style.maxWidth = sectionContainerWidth + 'px';
  equationContent.style.padding = `0 ${sectionContainerPadding}px`;
}

isSticky = true;
} else if (scrollY <= originalTop && isSticky) {
// 取消固定
equationContainer.classList.remove('sticky');
placeholder.classList.remove('active');
equationContainer.style.backgroundColor = '';

// 重置内容部分样式
const equationContent = equationContainer.querySelector('.equation-content');
if (equationContent) {
  equationContent.style.maxWidth = '';
  equationContent.style.padding = '';
}

isSticky = false;
}
}

// 处理窗口大小变化的函数
function handleResize() {
// 重新测量白色背景区域的宽度
const newSectionContainerWidth = document.querySelector('.section-container').offsetWidth;
const newSectionContainerPadding = parseInt(window.getComputedStyle(document.querySelector('.section-container')).padding);

// 更新悬浮状态下的宽度
if (isSticky) {
  const equationContent = equationContainer.querySelector('.equation-content');
  if (equationContent) {
    equationContent.style.maxWidth = newSectionContainerWidth + 'px';
    equationContent.style.padding = `0 ${newSectionContainerPadding}px`;
  }
}
}

// 添加事件监听器
window.addEventListener('scroll', handleScroll);
window.addEventListener('resize', handleResize);

// 初始触发一次滚动处理，以防页面已经滚动
handleScroll();
}

// 显示搜索建议
function showSuggestions(input, type) {
const query = input.value.trim();
if (query.length < 1) {
const suggestionsId = input.id.replace('Search', 'Suggestions');
document.getElementById(suggestionsId).classList.remove('active');
return;
}

const suggestionsId = input.id.replace('Search', 'Suggestions');
const suggestionsContainer = document.getElementById(suggestionsId);
if (!suggestionsContainer) return;

suggestionsContainer.innerHTML = '';
suggestionsContainer.classList.add('active');

// 模拟搜索结果
const results = [
{ id: 'K001', name: query + '相关知识1', owner: '张三' },
{ id: 'K002', name: query + '相关知识2', owner: '李四' },
{ id: 'K003', name: query + '相关知识3', owner: '王五' },
{ id: 'K004', name: query + '相关知识4', owner: '赵六' }
];

results.forEach(result => {
const item = document.createElement('div');
item.className = 'suggestion-item';
item.innerHTML = `
<span class="suggestion-id">${result.id}</span>
<span class="suggestion-name">${result.name}</span>
<span class="suggestion-owner">责任人: ${result.owner}</span>
`;
item.addEventListener('click', () => {
selectSuggestion(result, type);
});
suggestionsContainer.appendChild(item);
});
}

// 选择搜索建议
function selectSuggestion(result, type) {
if (type === 'requirement') {
// 添加到整体要求
const container = document.getElementById('selectedRequirements');
const item = document.createElement('div');
item.className = 'selected-item';
item.innerHTML = `
<span>${result.name}</span>
<span class="remove" onclick="this.closest('.selected-item').remove()">×</span>
`;
container.appendChild(item);
} else {
// 添加到其他类型
const dataset = currentModalDataset;
const containerId = `${dataset}-selected-${type}`;
const container = document.getElementById(containerId);
if (container) {
const item = document.createElement('div');
item.className = 'selected-item';
item.innerHTML = `
<span>${result.name}</span>
<span class="remove" onclick="removeStrategy(this, '${result.name}', '${dataset}', '${type}')">×</span>
`;
container.appendChild(item);

// 添加到对应的存储结构
if (type === 'diagnosis') {
if (!selectedKnowledge[dataset]) {
selectedKnowledge[dataset] = [];
}
selectedKnowledge[dataset].push(result.name);
} else if (type === 'management') {
if (!selectedManagementStrategies[dataset]) {
selectedManagementStrategies[dataset] = [];
}
selectedManagementStrategies[dataset].push(result.name);
}

// 更新等式中的标签
updateEquationTags();
}
}

// 隐藏建议框
const suggestionsId = type === 'requirement' ? 'requirementSuggestions' : (currentModalDataset + type + 'Suggestions');
const suggestionsEl = document.getElementById(suggestionsId);
if (suggestionsEl) {
suggestionsEl.classList.remove('active');
}
}

// 添加知识到整体要求
function addKnowledgeToRequirement(card) {
const title = card.querySelector('.card-title').textContent;
const container = document.getElementById('selectedRequirements');


// 检查是否已存在
let exists = false;
container.querySelectorAll('.selected-item').forEach(item => {
if (item.textContent.includes(title)) {
exists = true;
}
});

if (!exists) {
const item = document.createElement('div');
item.className = 'selected-item';
item.innerHTML = `${title}<span class="remove" onclick="this.closest('.selected-item').remove()">×</span>`;
container.appendChild(item);
}
}

// 打开知识选择弹窗
let currentModalType = '';
let currentModalDataset = '';
let selectedModalItems = [];

function openKnowledgeModal(type, dataset) {
currentModalType = type;
currentModalDataset = dataset || '';
selectedModalItems = [];

// 根据类型设置弹窗标题
const modalTitle = document.querySelector('.modal-title');
if (type === 'diagnosis') {
modalTitle.textContent = '选择业务知识';
} else if (type === 'management') {
modalTitle.textContent = '选择管理策略';
} else if (type === 'requirement') {
modalTitle.textContent = '选择整体要求知识';
}

// 加载知识列表
loadKnowledgeList();

// 重置筛选器
document.getElementById('level1Filter').value = '';
document.getElementById('level2Filter').innerHTML = '<option value="">全部</option>';
document.getElementById('level3Filter').innerHTML = '<option value="">全部</option>';
document.getElementById('businessLineFilter').value = '';
document.getElementById('ownerFilter').value = '';
document.getElementById('modalSearchInput').value = '';

// 显示弹窗
document.getElementById('knowledgeModal').classList.add('active');
}

// 关闭弹窗
function closeModal(modalId) {
document.getElementById(modalId).classList.remove('active');
}

// 确认选择知识
function confirmKnowledgeSelection() {
// 获取选中的知识
const checkboxes = document.querySelectorAll('#knowledgeList .knowledge-checkbox:checked');
if (checkboxes.length === 0) {
alert('请至少选择一个知识');
return;
}

// 根据不同类型处理选择结果
if (currentModalType === 'requirement') {
// 添加到整体要求
const container = document.getElementById('selectedRequirements');
checkboxes.forEach(checkbox => {
const item = checkbox.closest('.knowledge-item');
const title = item.querySelector('.knowledge-title').textContent;


// 检查是否已存在
let exists = false;
container.querySelectorAll('.selected-item').forEach(existingItem => {
if (existingItem.textContent.includes(title)) {
exists = true;
}
});

if (!exists) {
const newItem = document.createElement('div');
newItem.className = 'selected-item';
newItem.innerHTML = `${title}<span class="remove" onclick="this.closest('.selected-item').remove()">×</span>`;
container.appendChild(newItem);
}
});
} else {
// 添加到业务知识或管理策略
const container = document.getElementById(`${currentModalDataset}-selected-${currentModalType}`);
if (container) {
checkboxes.forEach(checkbox => {
const item = checkbox.closest('.knowledge-item');
const title = item.querySelector('.knowledge-title').textContent;


// 检查是否已存在
let exists = false;
container.querySelectorAll('.selected-item').forEach(existingItem => {
if (existingItem.textContent.includes(title)) {
exists = true;
}
});

if (!exists) {
const newItem = document.createElement('div');
newItem.className = 'selected-item';
newItem.innerHTML = `${title}<span class="remove" onclick="removeStrategy(this, '${title}', '${currentModalDataset}', '${currentModalType}')">×</span>`;
container.appendChild(newItem);

// 添加到对应的存储结构
if (currentModalType === 'diagnosis') {
if (!selectedKnowledge[currentModalDataset]) {
selectedKnowledge[currentModalDataset] = [];
}
selectedKnowledge[currentModalDataset].push(title);
} else if (currentModalType === 'management') {
if (!selectedManagementStrategies[currentModalDataset]) {
selectedManagementStrategies[currentModalDataset] = [];
}
selectedManagementStrategies[currentModalDataset].push(title);
}
}
});

// 更新等式中的标签
updateEquationTags();
}
}

// 关闭弹窗
closeModal('knowledgeModal');
}

// 加载知识列表
function loadKnowledgeList() {
const container = document.getElementById('knowledgeList');
container.innerHTML = '';

// 模拟知识数据
const knowledgeItems = [
{ id: 'K001', title: '业绩同比环比分析', owner: '张三', type: '分析方法', level1: '业务分析', level2: '业绩分析', level3: '同比环比', businessLine: '全业务线' },
{ id: 'K002', title: '业务结构占比分析', owner: '李四', type: '分析方法', level1: '业务分析', level2: '业绩分析', level3: '结构分析', businessLine: '租赁' },
{ id: 'K003', title: '人效指标分析', owner: '王五', type: '效能分析', level1: '业务分析', level2: '效能分析', level3: '人效分析', businessLine: '二手房' },
{ id: 'K004', title: '租赁市场周期波动', owner: '赵六', type: '市场分析', level1: '市场研究', level2: '周期分析', level3: '波动规律', businessLine: '租赁' },
{ id: 'K005', title: '房源质量评估', owner: '张三', type: '质量分析', level1: '业务分析', level2: '房源分析', level3: '质量评估', businessLine: '全业务线' },
{ id: 'K006', title: '客源转化漏斗', owner: '李四', type: '转化分析', level1: '业务分析', level2: '客源分析', level3: '转化过程', businessLine: '二手房' },
{ id: 'K007', title: '区域差异化分析', owner: '王五', type: '区域分析', level1: '市场研究', level2: '区域分析', level3: '差异化', businessLine: '全业务线' },
{ id: 'K008', title: '团队激励方案', owner: '赵六', type: '管理方法', level1: '管理方法', level2: '团队管理', level3: '激励机制', businessLine: '全业务线' },
{ id: 'K009', title: '带看质量提升', owner: '张三', type: '提升方法', level1: '管理方法', level2: '业务提升', level3: '带看优化', businessLine: '二手房' },
{ id: 'K010', title: '商机响应效率', owner: '李四', type: '效率分析', level1: '业务分析', level2: '商机分析', level3: '响应效率', businessLine: '新房' }
];

// 根据当前模态框类型过滤知识
let filteredItems = knowledgeItems;
if (currentModalType === 'diagnosis') {
filteredItems = knowledgeItems.filter(item => 
item.level1 === '业务分析' || item.level1 === '市场研究'
);
} else if (currentModalType === 'management') {
filteredItems = knowledgeItems.filter(item => 
item.level1 === '管理方法' || item.type.includes('提升') || item.type.includes('策略')
);
}

// 渲染知识列表
filteredItems.forEach(item => {
const element = document.createElement('div');
element.className = 'knowledge-item';
element.innerHTML = `
<input type="checkbox" class="knowledge-checkbox">
<div class="knowledge-info">
<div class="knowledge-title">${item.title}</div>
<div class="knowledge-meta">
<div class="knowledge-id"><i class="fas fa-hashtag"></i>${item.id}</div>
<div class="knowledge-owner"><i class="fas fa-user"></i>${item.owner}</div>
<div class="knowledge-type"><i class="fas fa-tag"></i>${item.type}</div>
</div>
</div>
`;
container.appendChild(element);
});
}

// 更新二级标签选项
function updateLevel2Options() {
const level1 = document.getElementById('level1Filter').value;
const level2Select = document.getElementById('level2Filter');
level2Select.innerHTML = '<option value="">全部</option>';

// 根据选中的一级标签生成对应的二级标签
if (level1 === '业务分析') {
addOption(level2Select, '业绩分析');
addOption(level2Select, '房源分析');
addOption(level2Select, '客源分析');
addOption(level2Select, '带看分析');
addOption(level2Select, '商机分析');
addOption(level2Select, '效能分析');
} else if (level1 === '市场研究') {
addOption(level2Select, '周期分析');
addOption(level2Select, '区域分析');
addOption(level2Select, '竞品分析');
addOption(level2Select, '趋势预测');
} else if (level1 === '管理方法') {
addOption(level2Select, '团队管理');
addOption(level2Select, '业务提升');
addOption(level2Select, '资源配置');
addOption(level2Select, '绩效管理');
}

// 更新三级标签
updateLevel3Options();
}

// 更新三级标签选项
function updateLevel3Options() {
const level1 = document.getElementById('level1Filter').value;
const level2 = document.getElementById('level2Filter').value;
const level3Select = document.getElementById('level3Filter');
level3Select.innerHTML = '<option value="">全部</option>';

// 根据选中的二级标签生成对应的三级标签
if (level2 === '业绩分析') {
addOption(level3Select, '同比环比');
addOption(level3Select, '结构分析');
addOption(level3Select, '预测分析');
} else if (level2 === '房源分析') {
addOption(level3Select, '质量评估');
addOption(level3Select, '结构分布');
addOption(level3Select, '周转率');
} else if (level2 === '区域分析') {
addOption(level3Select, '差异化');
addOption(level3Select, '区域特征');
addOption(level3Select, '发展潜力');
} else if (level2 === '团队管理') {
addOption(level3Select, '激励机制');
addOption(level3Select, '团队协作');
addOption(level3Select, '绩效考核');
}

// 应用筛选
filterKnowledgeList();
}

// 添加选项到select
function addOption(select, value) {
const option = document.createElement('option');
option.value = value;
option.textContent = value;
select.appendChild(option);
}

// 筛选知识列表
function filterKnowledgeList() {
const searchText = document.getElementById('modalSearchInput').value.toLowerCase();
const level1 = document.getElementById('level1Filter').value;
const level2 = document.getElementById('level2Filter').value;
const level3 = document.getElementById('level3Filter').value;
const businessLine = document.getElementById('businessLineFilter').value;
const owner = document.getElementById('ownerFilter').value;

// 获取所有知识项
const items = document.querySelectorAll('#knowledgeList .knowledge-item');

items.forEach(item => {
const title = item.querySelector('.knowledge-title').textContent.toLowerCase();
const ownerText = item.querySelector('.knowledge-owner').textContent.toLowerCase();
const typeText = item.querySelector('.knowledge-type').textContent.toLowerCase();
const id = item.querySelector('.knowledge-id').textContent.toLowerCase();

// 检查是否符合搜索条件
const matchesSearch = searchText === '' || 
                      title.includes(searchText) || 
                      ownerText.includes(searchText) || 
                      typeText.includes(searchText) || 
                      id.includes(searchText);

// 在实际应用中，还需要检查层级标签和单级筛选器
// 这里仅做模拟，实际应用需要从知识项中获取相关数据
const matchesFilters = true; // 简化处理，实际应用中需要根据筛选条件判断

if (matchesSearch && matchesFilters) {
item.style.display = '';
} else {
item.style.display = 'none';
}
});
}

// 存储已选中的数据集
let selectedDatasets = [];

// 存储选中数据集的顺序和编号
let datasetOrder = {};

// 存储已选中的分析对象
let selectedObjects = [];

// 存储已选中的业务知识（按数据集）
let selectedKnowledge = {};

// 存储已选中的管理策略（按数据集）
let selectedManagementStrategies = {};

// 滚动到指定部分
function scrollToSection(sectionId) {
// 移除所有高亮
document.querySelectorAll('#analysisPathPage .equation-item').forEach(item => {
item.classList.remove('active');
});
document.querySelectorAll('#analysisPathPage .section-header').forEach(header => {
header.classList.remove('highlight');
});

// 给点击的等式项添加高亮
document.getElementById('equation' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1, -7)).classList.add('active');

// 给对应的section header添加高亮
const headerId = sectionId.replace('Section', 'Header');
document.getElementById(headerId).classList.add('highlight');

// 滚动到对应部分
const section = document.getElementById(sectionId);
if (section) {
section.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// 2秒后移除高亮
setTimeout(() => {
document.getElementById(headerId).classList.remove('highlight');
}, 2000);
}

// 更新等式中的标签
function updateEquationTags() {
// 更新分析模块标签 - 添加编号
const moduleTagsContainer = document.getElementById('selectedModuleTags');
moduleTagsContainer.innerHTML = '';

// 按顺序添加标签
selectedDatasets.forEach(module => {
const tag = document.createElement('div');
tag.className = 'equation-tag equation-tag-module';
// 在标签前面添加编号
const order = datasetOrder[module];
if (order) {
tag.textContent = `${order}.${module}`;
} else {
tag.textContent = module;
}
moduleTagsContainer.appendChild(tag);
});

// 更新业务知识标签
const knowledgeTagsContainer = document.getElementById('selectedKnowledgeTags');
knowledgeTagsContainer.innerHTML = '';
const allKnowledge = new Set();
Object.values(selectedKnowledge).forEach(knowledgeArray => {
knowledgeArray.forEach(k => allKnowledge.add(k));
});
Array.from(allKnowledge).forEach(knowledge => {
const tag = document.createElement('div');
tag.className = 'equation-tag equation-tag-knowledge';
tag.textContent = knowledge;
knowledgeTagsContainer.appendChild(tag);
});

// 更新管理策略标签
const strategyTagsContainer = document.getElementById('selectedStrategyTags');
strategyTagsContainer.innerHTML = '';
const allStrategies = new Set();
Object.values(selectedManagementStrategies).forEach(strategyArray => {
strategyArray.forEach(s => allStrategies.add(s));
});
Array.from(allStrategies).forEach(strategy => {
const tag = document.createElement('div');
tag.className = 'equation-tag equation-tag-strategy';
tag.textContent = strategy;
strategyTagsContainer.appendChild(tag);
});
}

// 重新布局已选项目，添加编号和箭头
function updateSelectedMetricsLayout() {
const container = document.getElementById('selectedMetrics');
const items = Array.from(container.querySelectorAll('.selected-item'));
  
// 清空当前显示
container.innerHTML = '';
  
// 重置编号顺序
datasetOrder = {};
  
// 重建带编号的项目和箭头
for (let i = 0; i < items.length; i++) {
const item = items[i];
    
// 创建新的项目元素
const newItem = document.createElement('div');
newItem.className = 'selected-item';
    
// 提取标题
const content = item.textContent;
const title = content.split(': ')[1].replace('×', '').trim();
    
// 添加编号 - 从1开始
const number = document.createElement('span');
number.className = 'item-number';
number.textContent = i + 1;
    
// 更新数据集的顺序，保存编号 - 从1开始
datasetOrder[title] = i + 1;
    
// 组装元素
newItem.appendChild(number);
newItem.innerHTML += `<span>分析模块: ${title}</span>`;
newItem.innerHTML += `<span class="remove" onclick="removeMetric(this, '${title}', 'metricSet')" >×</span>`;
    
// 添加到容器
container.appendChild(newItem);
    
// 如果不是最后一个，添加箭头
if (i < items.length - 1) {
const arrow = document.createElement('div');
arrow.className = 'item-arrow';
arrow.innerHTML = '<i class="fas fa-long-arrow-alt-right"></i>';
container.appendChild(arrow);
}
}
  
// 更新等式中的标签
updateEquationTags();
  
// 更新业务知识和管理策略区域 - 以确保编号正确
updateDiagnosisAndManagement();
}

// 分析模块选择功能
function toggleSelection(card, type) {
card.classList.toggle('selected');
const title = card.querySelector('.card-title').textContent;

updateSelectedMetrics(card, type);

if (card.classList.contains('selected')) {
// 添加到选中的数据集
selectedDatasets.push(title);
} else {
// 从选中的数据集中移除
selectedDatasets = selectedDatasets.filter(set => set !== title);

// 移除顺序号
delete datasetOrder[title];

// 清除相关的业务知识和管理策略
delete selectedKnowledge[title];
delete selectedManagementStrategies[title];
}

// 更新业务知识和管理策略区域
updateDiagnosisAndManagement();
}

// 更新已选中的分析模块
function updateSelectedMetrics(card, type) {
const container = document.getElementById('selectedMetrics');
const title = card.querySelector('.card-title').textContent;

if (card.classList.contains('selected')) {
// 添加到已选项目
const item = document.createElement('div');
item.className = 'selected-item';
item.innerHTML = `<span>分析模块: ${title}</span><span class="remove" onclick="removeMetric(this, '${title}', '${type}')">×</span>`;
container.appendChild(item);
// 在添加后立即更新布局
updateSelectedMetricsLayout();
} else {
// 从已选项目中移除
container.querySelectorAll('.selected-item').forEach(item => {
if (item.textContent.includes(`分析模块: ${title}`)) {
item.remove();
}
});
// 在移除后立即更新布局
updateSelectedMetricsLayout();
}
}

// 移除选中的分析模块
function removeMetric(element, title, type) {
// 找到对应的卡片并取消选中
document.querySelectorAll('.card').forEach(card => {
if (card.querySelector('.card-title').textContent === title) {
card.classList.remove('selected');

selectedDatasets = selectedDatasets.filter(set => set !== title);

// 移除顺序号
delete datasetOrder[title];

// 清除相关的业务知识和管理策略
delete selectedKnowledge[title];
delete selectedManagementStrategies[title];

updateDiagnosisAndManagement();
}
});

// 移除元素
element.closest('.selected-item').remove();

// 重新布局其余元素
updateSelectedMetricsLayout();
}

// 更新业务知识和管理策略区域
function updateDiagnosisAndManagement() {
const diagnosisContainer = document.getElementById('diagnosisContainer');
const managementContainer = document.getElementById('managementContainer');

// 如果没有选中数据集，显示提示信息
if (selectedDatasets.length === 0) {
document.getElementById('noDatasetsMessage1').style.display = 'block';
document.getElementById('noDatasetsMessage2').style.display = 'block';

// 清空已有内容
const diagnosisItems = diagnosisContainer.querySelectorAll('.dataset-strategy-container');
diagnosisItems.forEach(item => item.remove());

const managementItems = managementContainer.querySelectorAll('.dataset-strategy-container');
managementItems.forEach(item => item.remove());

return;
}

// 隐藏提示信息
document.getElementById('noDatasetsMessage1').style.display = 'none';
document.getElementById('noDatasetsMessage2').style.display = 'none';

// 为每个选中的数据集创建业务知识选择区域
selectedDatasets.forEach(dataset => {
// 检查是否已存在该数据集的配置区域
const existingDiagnosis = diagnosisContainer.querySelector(`[data-dataset="${dataset}"]`);
if (!existingDiagnosis) {
// 创建业务知识配置区域，添加编号
const diagnosisElement = createDatasetStrategyElement(dataset, 'diagnosis');
diagnosisContainer.appendChild(diagnosisElement);
}

// 检查是否已存在该数据集的管理策略配置区域
const existingManagement = managementContainer.querySelector(`[data-dataset="${dataset}"]`);
if (!existingManagement) {
// 创建管理策略配置区域，添加编号
const managementElement = createDatasetStrategyElement(dataset, 'management');
managementContainer.appendChild(managementElement);
}
});

// 移除不再需要的配置区域
diagnosisContainer.querySelectorAll('.dataset-strategy-container').forEach(item => {
const datasetName = item.getAttribute('data-dataset');
if (!selectedDatasets.includes(datasetName)) {
item.remove();
}
});

managementContainer.querySelectorAll('.dataset-strategy-container').forEach(item => {
const datasetName = item.getAttribute('data-dataset');
if (!selectedDatasets.includes(datasetName)) {
item.remove();
}
});
}

// 创建数据集策略选择元素，添加编号和筛选器
function createDatasetStrategyElement(dataset, type) {
const container = document.createElement('div');
container.className = 'dataset-strategy-container';
container.setAttribute('data-dataset', dataset);

const header = document.createElement('div');
header.className = 'dataset-header';

// 获取数据集编号 - 使用正确的序号
const datasetNum = datasetOrder[dataset] || 1;

const title = document.createElement('div');
title.className = 'dataset-title';
title.innerHTML = `为 <span class="item-number">${datasetNum}</span> ${dataset} 分析模块选择${type === 'diagnosis' ? '业务知识' : '管理策略'}`;

header.appendChild(title);
container.appendChild(header);

// 添加搜索框
const searchFilter = document.createElement('div');
searchFilter.className = 'search-filter';
searchFilter.innerHTML = `
<i class="fas fa-search"></i>
<input type="text" placeholder="搜索${type === 'diagnosis' ? '业务知识' : '管理策略'}..." id="${dataset}${type}Search">
<div class="search-suggestions" id="${dataset}${type}Suggestions"></div>
`;
container.appendChild(searchFilter);

// 添加搜索框事件监听
setTimeout(() => {
const searchInput = document.getElementById(`${dataset}${type}Search`);
if (searchInput) {
searchInput.addEventListener('focus', function() {
if (this.value.trim().length > 0) {
showSuggestions(this, type);
}
});

searchInput.addEventListener('blur', function() {
setTimeout(() => {
const suggestionsId = this.id.replace('Search', 'Suggestions');
const suggestionsBox = document.getElementById(suggestionsId);
if (suggestionsBox) {
suggestionsBox.classList.remove('active');
}
}, 200);
});

searchInput.addEventListener('keyup', function() {
const query = this.value.trim();
if (query.length > 0) {
showSuggestions(this, type);
} else {
const suggestionsId = this.id.replace('Search', 'Suggestions');
const suggestionsBox = document.getElementById(suggestionsId);
if (suggestionsBox) {
suggestionsBox.classList.remove('active');
}
}
});
}
}, 0);

// 添加推荐的前三个选项
const recommendationsContainer = document.createElement('div');
recommendationsContainer.className = 'top-recommendations';

// 生成不同的推荐内容
let recommendedItems = [];
if (type === 'diagnosis') {
  if (dataset === '业绩') {
    recommendedItems = ['业绩同比环比分析', '业务结构占比分析', '人效指标分析'];
  } else if (dataset === '房源') {
    recommendedItems = ['房源质量评估', '房源结构分析', '上架时间与成交率'];
  } else if (dataset === '客源') {
    recommendedItems = ['客源转化漏斗', '客源质量分级', '购买意向度评估'];
  } else if (dataset === '带看') {
    recommendedItems = ['带看至成交转化率', '带看频次与成交关系', '带看客户满意度'];
  } else if (dataset === '商机') {
    recommendedItems = ['商机分级系统', '商机响应时效', '商机来源分布'];
  }
} else {
  if (dataset === '业绩') {
    recommendedItems = ['业绩提升策略', '团队激励方案', '增长瓶颈突破'];
  } else if (dataset === '房源') {
    recommendedItems = ['房源质量提升', '独家委托策略', '房源结构优化'];
  } else if (dataset === '客源') {
    recommendedItems = ['高质客源获取', '客户分级跟进', '客户转化提升'];
  } else if (dataset === '带看') {
    recommendedItems = ['带看质量提升', '带看流程优化', '带看体验提升'];
  } else if (dataset === '商机') {
    recommendedItems = ['商机筛选策略', '商机响应效率', '商机转化策略'];
  }
}

recommendationsContainer.innerHTML = `<h4>推荐的${type === 'diagnosis' ? '业务知识' : '管理策略'}</h4>`;

// 创建推荐项目卡片容器
const recommendedCards = document.createElement('div');
recommendedCards.className = 'card-grid';

// 添加推荐的三个卡片
recommendedItems.forEach(item => {
  const card = document.createElement('div');
  card.className = 'card';
  card.setAttribute('onclick', `toggleStrategySelection(this, '${dataset}', '${type}')`);
  
  card.innerHTML = `
    <div class="card-title">${item}</div>
    <div class="card-description">针对${dataset}的${type === 'diagnosis' ? '分析知识' : '管理方法'}</div>
  `;
  
  recommendedCards.appendChild(card);
});

recommendationsContainer.appendChild(recommendedCards);

// 添加查看更多按钮
const seeMoreButton = document.createElement('button');
seeMoreButton.className = 'see-more-btn';
seeMoreButton.innerHTML = '查看更多...';
seeMoreButton.setAttribute('onclick', `openKnowledgeModal('${type}', '${dataset}')`);
recommendationsContainer.appendChild(seeMoreButton);

container.appendChild(recommendationsContainer);

// 添加已选项目容器
const selectedItemsContainer = document.createElement('div');
selectedItemsContainer.className = 'selected-items';
selectedItemsContainer.id = `${dataset}-selected-${type}`;
container.appendChild(selectedItemsContainer);

return container;
}

// 业务知识/管理策略选择切换
function toggleStrategySelection(card, dataset, type) {
card.classList.toggle('selected');

const title = card.querySelector('.card-title').textContent;
const containerId = `${dataset}-selected-${type}`;
const container = document.getElementById(containerId);

// 初始化数据结构（如果不存在）
if (type === 'diagnosis') {
if (!selectedKnowledge[dataset]) {
selectedKnowledge[dataset] = [];
}
} else {
if (!selectedManagementStrategies[dataset]) {
selectedManagementStrategies[dataset] = [];
}
}

if (card.classList.contains('selected')) {
// 添加到已选项目
const item = document.createElement('div');
item.className = 'selected-item';
item.innerHTML = `${title}<span class="remove" onclick="removeStrategy(this, '${title}', '${dataset}', '${type}')">×</span>`;
container.appendChild(item);

// 添加到对应的存储结构
if (type === 'diagnosis') {
selectedKnowledge[dataset].push(title);
} else {
selectedManagementStrategies[dataset].push(title);
}
} else {
// 从已选项目中移除
container.querySelectorAll('.selected-item').forEach(item => {
if (item.textContent.includes(title)) {
item.remove();
}
});

// 从存储结构中移除
if (type === 'diagnosis') {
selectedKnowledge[dataset] = selectedKnowledge[dataset].filter(k => k !== title);
} else {
selectedManagementStrategies[dataset] = selectedManagementStrategies[dataset].filter(s => s !== title);
}
}

// 更新等式中的标签
updateEquationTags();
}

// 移除选中的策略
function removeStrategy(element, title, dataset, type) {
// 找到对应的卡片并取消选中
const container = document.querySelector(`[data-dataset="${dataset}"]`);
container.querySelectorAll('.card').forEach(card => {
if (card.querySelector('.card-title').textContent === title) {
card.classList.remove('selected');
}
});

// 从存储结构中移除
if (type === 'diagnosis') {
if (selectedKnowledge[dataset]) {
selectedKnowledge[dataset] = selectedKnowledge[dataset].filter(k => k !== title);
}
} else {
if (selectedManagementStrategies[dataset]) {
selectedManagementStrategies[dataset] = selectedManagementStrategies[dataset].filter(s => s !== title);
}
}

// 移除元素
element.closest('.selected-item').remove();

// 更新等式中的标签
updateEquationTags();
}

// 分析对象选择切换
function toggleObject(element, orgType) {
element.classList.toggle('selected');
const objectName = element.textContent;
const compoundName = `${orgType}:${objectName}`;

if (element.classList.contains('selected')) {
// 添加到选中的分析对象
if (!selectedObjects.includes(compoundName)) {
selectedObjects.push(compoundName);
}
} else {
// 从选中的分析对象中移除
selectedObjects = selectedObjects.filter(obj => obj !== compoundName);
}
}

// 模拟加载分析思路数据
function simulateLoadPathData(item) {
// 清空现有选择
clearForm();

// 设置分析对象
const objectTags = item.querySelectorAll('.tag.tag-object');
objectTags.forEach(tag => {
const objectName = tag.textContent.replace('分析对象: ', '');
// 默认添加到贝壳城市运营类别
document.querySelectorAll('#beikeOrgContent .object-chip').forEach(chip => {
if (chip.textContent === objectName) {
chip.classList.add('selected');
selectedObjects.push(`beike:${objectName}`);
}
});
});

// 获取所有模块标签
const moduleTags = item.querySelectorAll('.mindmap-tag-module');
moduleTags.forEach((tag, index) => {
// 提取不包含编号的模块名
const tagText = tag.textContent;
const moduleName = tagText.replace(/^\d+\./, '').trim();
// 模拟点击对应的卡片
document.querySelectorAll('.card').forEach(card => {
if (card.querySelector('.card-title').textContent === moduleName) {
toggleSelection(card, 'metricSet');
}
});
});

// 在实际应用中，这里应该加载关联的业务知识、管理策略和整体要求数据
// 为演示，模拟添加一些整体要求
document.getElementById('overallRequirement').value = "每月重点关注业绩指标的波动趋势，特别是与上季度相比的变化。关注异常数据并进行深入分析。";
addKnowledgeToRequirement(document.querySelector('.card-grid .card'));
}

// 清空表单
function clearForm() {
document.getElementById('pathName').value = '';
document.getElementById('pathDescription').value = '';
document.getElementById('overallRequirement').value = '';

// 清除所有分析对象选择
document.querySelectorAll('.object-chip.selected').forEach(obj => {
obj.classList.remove('selected');
});
selectedObjects = [];

// 清除所有分析模块选择
document.querySelectorAll('.card.selected').forEach(card => {
card.classList.remove('selected');
});
document.getElementById('selectedMetrics').innerHTML = '';

// 重置数据集列表
selectedDatasets = [];
datasetOrder = {};

// 重置业务知识和管理策略
selectedKnowledge = {};
selectedManagementStrategies = {};

// 重置整体要求
document.getElementById('selectedRequirements').innerHTML = '';

// 重置业务知识和管理策略区域
resetDiagnosisAndManagement();

// 清除奇妙等式高亮
document.querySelectorAll('.equation-item').forEach(item => {
item.classList.remove('active');
});

// 清空等式中的标签
document.getElementById('selectedModuleTags').innerHTML = '';
document.getElementById('selectedKnowledgeTags').innerHTML = '';
document.getElementById('selectedStrategyTags').innerHTML = '';
}

// 重置业务知识和管理策略区域
function resetDiagnosisAndManagement() {
if (!document.getElementById('noDatasetsMessage1')) return;

// 显示提示信息
document.getElementById('noDatasetsMessage1').style.display = 'block';
document.getElementById('noDatasetsMessage2').style.display = 'block';

// 清空已有内容
document.getElementById('diagnosisContainer').querySelectorAll('.dataset-strategy-container').forEach(item => {
item.remove();
});

document.getElementById('managementContainer').querySelectorAll('.dataset-strategy-container').forEach(item => {
item.remove();
});
}
</script>
</body>
</html>
